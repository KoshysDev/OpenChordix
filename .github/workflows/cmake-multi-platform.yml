name: CMake Build (Windows + Arch Linux)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows configuration
          - os: windows-latest
            generator: Ninja
            vcpkg_triplet: x64-windows

          # Arch Linux configuration
          - os: ubuntu-latest
            container: archlinux:latest
            generator: Ninja

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    defaults:
      run:
        shell: ${{ matrix.os == 'windows-latest' && 'pwsh' || 'bash' }}

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Windows: vcpkg setup & cache ----------
      - name: Cache vcpkg artifacts [Windows]
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed/
            ${{ env.VCPKG_ROOT }}/packages/
            ${{ env.VCPKG_ROOT }}/buildtrees/
            ${{ env.VCPKG_ROOT }}/downloads/
          key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}-${{ hashFiles('**/vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Setup vcpkg (manifest) [Windows]
        if: matrix.os == 'windows-latest'
        uses: lukka/run-vcpkg@v11.5
        with:
          vcpkgDirectory: ${{ env.VCPKG_ROOT }}
          vcpkgTriplet: ${{ matrix.vcpkg_triplet }}
          runInstall: true

      - name: Configure (Windows)
        if: matrix.os == 'windows-latest'
        run: >
          cmake -S . -B build
          -G "${{ matrix.generator }}"
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }}

      # ---------- Arch container: system deps + yay (AUR) ----------
      - name: Install base system deps [Arch container]
        if: matrix.container != ''
        run: |
          set -euxo pipefail
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel cmake ninja git pkgconf \
                              sdl2 rtaudio aubio ffmpeg alsa-lib sudo go

          # Create non-root build user for makepkg (AUR requirement)
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"

      - name: Install AUR deps via yay [Arch container]
        if: matrix.container != ''
        run: |
          set -euxo pipefail
          sudo -u builder bash -lc '
            cd ~
            git clone https://aur.archlinux.org/yay-bin.git
            cd yay-bin
            makepkg -si --noconfirm --needed

            export YAYFLAGS="--noconfirm --needed --mflags --noconfirm"
            yay -Syu $YAYFLAGS

            # GENie is required by bgfx-git to generate the linux-* make targets
            yay -S $YAYFLAGS genie-bin

            yay -S $YAYFLAGS bgfx-git imgui-full
          '

      - name: Configure (Linux)
        if: matrix.container != ''
        run: >
          cmake -S . -B build
          -G "${{ matrix.generator }}"
          -DCMAKE_BUILD_TYPE=Release

      # ---------- Build (both platforms) ----------
      - name: Build
        run: cmake --build build --config Release -- -k 0
