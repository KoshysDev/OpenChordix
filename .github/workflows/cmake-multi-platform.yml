name: CMake Build (Windows + Arch Linux)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows configuration
          - os: windows-latest
            generator: MinGW Makefiles
            vcpkg_triplet: x64-mingw-dynamic

          # Arch Linux configuration
          - os: ubuntu-latest
            container: archlinux:latest
            generator: Unix Makefiles

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    defaults:
      run:
        shell: ${{ matrix.os == 'windows-latest' && 'pwsh' || 'bash' }}

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Windows: vcpkg setup & cache ----------
      - name: Cache vcpkg artifacts [Windows]
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed/
            ${{ env.VCPKG_ROOT }}/packages/
            ${{ env.VCPKG_ROOT }}/buildtrees/
            ${{ env.VCPKG_ROOT }}/downloads/
          key: vcpkg-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}-${{ hashFiles('**/vcpkg-configuration.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install MinGW toolchain [Windows]
        if: matrix.os == 'windows-latest'
        run: |
          choco install mingw -y
          echo "C:\tools\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Setup vcpkg (manifest) [Windows]
        if: matrix.os == 'windows-latest'
        uses: lukka/run-vcpkg@v11.5
        with:
          vcpkgDirectory: ${{ env.VCPKG_ROOT }}
          vcpkgTriplet: ${{ matrix.vcpkg_triplet }}
          runInstall: true

      - name: Cache CMake build folder [Windows]
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: build
          key: cmake-build-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'cmake/**/*.cmake', 'src/**/*.cpp', 'src/**/*.h', 'vcpkg.json') }}
          restore-keys: |
            cmake-build-${{ runner.os }}-

      - name: Configure (Windows)
        if: matrix.os == 'windows-latest'
        run: >
          cmake -S . -B build
          -G "${{ matrix.generator }}"
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }}

      # ---------- Arch container: system deps + yay (AUR) ----------
      - name: Install base system deps [Arch container]
        if: matrix.os == 'ubuntu-latest' && matrix.container != ''
        run: |
          set -euxo pipefail
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel cmake git pkgconf sdl2 rtaudio aubio ffmpeg alsa-lib sudo
          useradd -m builder || true
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"

      - name: Cache AUR & pacman packages [Arch container]
        if: matrix.os == 'ubuntu-latest' && matrix.container != ''
        uses: actions/cache@v4
        with:
          path: |
            /home/builder/.cache/yay
            /var/cache/pacman/pkg
          key: aur-cache-${{ runner.os }}-${{ hashFiles('.github/workflows/**') }}
          restore-keys: |
            aur-cache-${{ runner.os }}-

      - name: Install AUR deps via yay [Arch container]
        if: matrix.os == 'ubuntu-latest' && matrix.container != ''
        run: |
          set -euxo pipefail
          sudo -u builder bash -lc '
            cd ~
            if [ ! -d yay-bin ]; then
              git clone https://aur.archlinux.org/yay-bin.git
            fi
            cd yay-bin
            makepkg -si --noconfirm --needed
            export YAYFLAGS="--noconfirm --needed --mflags --noconfirm"
            yay -Syu $YAYFLAGS
            yay -S $YAYFLAGS bgfx-cmake-git imgui-full
          '

      - name: Cache CMake build folder [Linux]
        if: matrix.os == 'ubuntu-latest'
        uses: actions/cache@v4
        with:
          path: build
          key: cmake-build-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'cmake/**/*.cmake', 'src/**/*.cpp', 'src/**/*.h') }}
          restore-keys: |
            cmake-build-${{ runner.os }}-

      # --- Configure CMake (Linux) ---
      - name: Configure (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cmake -B build -S . -G "${{ matrix.generator }}" -DCMAKE_BUILD_TYPE=Release

      # ---------- Build (both platforms) ----------
      - name: Build
        run: cmake --build build --config Release -- -k 0
